#!/bin/bash
# require: evaluation_file_path, result_file_path, error_file_path

set -e
set -x

# clone app
git clone $1 /app

if [ ! -f app/package.json ]; then
  echo "No se encontró el archivo package.json en la raiz del proyecto." >> <%= error_file_path %>
  exit 1
fi

if [ ! -f app/package.json ]; then
  echo "No se encontró el archivo app.js en la raiz del proyecto." >> <%= error_file_path %>
  exit 1
fi

yarn config set cache-folder /ukku/yarn-cache
PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true yarn add puppeteer@1.0.0
chmod -R 777 node_modules

yarn install

cp <%= evaluation_file_path %> .

node app/app.js &
child_pid=$!

node <%= evaluation_file_path %> &> <%= error_file_path %>
if [ -s <%= error_file_path %> ]
then
  exit 1
fi

kill "$child_pid"
