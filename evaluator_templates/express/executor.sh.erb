#!/bin/bash
# require: evaluation_file_path, result_file_path, error_file_path

set -e
set -x

# clone app
git clone $1 /app

if [ ! -f app/package.json ]; then
  echo "No se encontró el archivo package.json en la raiz del proyecto." >> <%= error_file_path %>
  exit 1
fi

if [ ! -f app/package.json ]; then
  echo "No se encontró el archivo app.js en la raiz del proyecto." >> <%= error_file_path %>
  exit 1
fi

cd /app
npm install
cd ..

yarn config set cache-folder /ukku/yarn-cache
PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true yarn add puppeteer@1.6.1
chmod -R 777 node_modules

cp <%= evaluation_file_path %> .

node app/app.js &
child_pid=$!

export NODE_PATH=/usr/lib/node_modules
mocha --timeout 7000 --reporter json <%= evaluation_file_path %> 1> <%= result_file_path %> 2> <%= error_file_path %>

kill "$child_pid"
